# Blueprint: Business Management System (BMS)

This document is the "Source of Truth" for the business logic embedded in the BMS Google Sheet.
Our goal is to reverse-engineer and document the exact business processes and financial calculations.

---

## ציר 1: מחזור החיים של נכס בודד (The "House" Lifecycle)
*This section focuses on the `House template` sheet as the master representation for any single property deal.*

### 1.1 שלב הגדרת העסקה (Deal Setup)
- ** מטרה עסקית:** לרשום את הפרמטרים הפיננסיים המרכזיים של עסקת המכר ללקוח ושל עלות רכישת החוזה לחברה. הנתונים בשלב זה הם "תמונת מצב" של החוזה כפי שנחתם, והם מהווים את הבסיס לכל החישובים העתידיים.
- ** טווח תאים רלוונטי:** `House template!A1:D13` (בערך)
- ** פירוט שדות ונוסחאות:**
    - **`B8 (price to buyer)`**: קלט ידני. מחיר הנכס המלא כפי שסוכם עם הקונה.
    - **`B9 (down payment)`**: קלט ידני. סכום המקדמה ששולמה על ידי הקונה.
    - **`B10 (loan amount)`**: נוסחה (`=B8-B9`). סכום ההלוואה הראשוני ללקוח.
    - **`B11 (rate)`**: קלט ידני. הריבית השנתית של הלקוח.
    - **`B12 (monthly payment)`**: קלט ידני. 
        - **היגיון עסקי (Intent):** שדה זה הוא קלט ידני מכיוון שהחברה מקבלת את החוזה לאחר שהוא כבר נחתם והתנאים בו נקבעו (לרוב באמצעות מחשבון משכנתא חיצוני). הגיליון משקף את המציאות החוזית ולא מחשב אותה מחדש. זה מאפשר גמישות לטפל בחוזים עם תשלומים שאינם סטנדרטיים (למשל, מספרים מעוגלים).
    - **`D9 (Discount amount)`**: קלט ידני. אחוז הדיסקאונט שבו החברה רוכשת את החוזה.
    - **`D10 (Price to segula)`**: נוסחה (`=(1-$D$9)*B10`). מחיר הרכישה של החוזה עבור החברה.
    - **`D12 (Starting Date)`**: קלט ידני. תאריך התשלום *הראשון* שעל הלקוח לשלם.

### 1.2 שלב התפעול השוטף (Ongoing Operations)
- ** מטרה עסקית:** לעקוב אחר תשלומים שהתקבלו בפועל מהלקוח, להשוות אותם ללוח התשלומים התיאורטי, ולחשב את יתרת הקרן המעודכנת ואת רכיבי הרווח של החברה.
- ** טווח תאים רלוונטי:** `House template!A18:X1002` (בערך)
- ** פירוט מבנה ונוסחאות:**
    - **המערכת מורכבת משתי טבלאות מרכזיות הפועלות במקביל:**
        1.  **טבלת אמורטיזציה תיאורטית (טורים R-X):** מייצגת את "העולם האידיאלי" - מה שהלקוח *אמור* לשלם בכל חודש לפי החוזה המקורי. טבלה זו אינה משתנה גם אם לקוח מפספס תשלום או משלם סכום אחר. זהו כלל עסקי מכוון לשמירת פשטות.
        2.  **טבלת מעקב תשלומים בפועל (טורים A-M):** מייצגת את "העולם האמיתי" - מה שהלקוח *שילם בפועל*.

    - **שדות מפתח ואינטראקציות:**
        - **`B (Date)`**: הנוסחה (`=TRIM(R19)`) מקשרת בין שתי הטבלאות על ידי משיכת התאריך התיאורטי, מה שמבטיח שכל שורה בטבלת המציאות מתייחסת לשורה בטבלת התיאוריה.
        - **`C (Payments recieved)`**: קלט ידני של הסכום שהתקבל. **הערה:** הזנת הנתונים לשדה זה ולשדות הנלווים (מיסים, ביטוח, הערות) מתבצעת באמצעות ממשק ייעודי ("Payment Dialog") כדי להבטיח אחידות ולהפחית טעויות.
        - **`H (interest)`**: הנוסחה (`=V19`) תמיד לוקחת את הריבית ה*תיאורטית* מאותה תקופה. ההיגיון הוא שהחברה תמיד "מכירה" באותה הוצאת ריבית חודשית, ללא קשר לסכום ששולם.
        - **`I (principal)`**: הנוסחה (`=C19-E19-F19-G19-H19`) מחשבת כמה מהתשלום בפועל הולך לכיסוי הקרן, וזאת *לאחר* שהופחתה הריבית התיאורטית.
        - **`L (UPB)`**: הנוסחה (`=U19 - I19`) מחשבת את יתרת החוב החדשה. היא לוקחת את היתרה התיאורטית מתחילת החודש ומפחיתה ממנה את הקרן ששולמה בפועל.
    
    - **עיקרון תצוגה מותנית-תאריך:**
        - רוב הנוסחאות בטבלאות עטופות בתנאי `IF` מורכב (למשל: `=IF(AND($B19<>"", YEAR($B19)<=YEAR(TODAY()), ...), [נוסחה], "")`).
        - **היגיון עסקי (Intent):** המטרה היא לשמור על הגיליון נקי וקריא על ידי הצגת נתונים היסטוריים בלבד (עד החודש הנוכחי). זה מונע הצגת תחזיות עתידיות וממקד את המשתמש במצב הקיים.

### 1.3 שלב ניתוח הרווחיות (Profitability Analysis)
- ** מטרה עסקית:** לתרגם את התשלומים המתקבלים לרכיבי רווח עבור החברה, ולסכם את הפעילות הפיננסית ברמה שנתית.
- ** טווח תאים רלוונטי:** `House template!J:K`, `House template!G3:X13`
- ** פירוט מבנה ונוסחאות:**
    - **פיצול הרווח ברמת התשלום:**
        - **`J (principal payback)`**: נוסחה (`=I19*(1-$D$9)`). מייצג את החלק היחסי של תשלום הקרן שהוא החזר על ההשקעה המקורית של החברה.
        - **`K (profit on discount)`**: נוסחה (`=I19*$D$9`). מייצג את הרווח הנקי מאותו תשלום, הנובע מהדיסקאונט שהושג בעת רכישת החוזה.
        - **היגיון עסקי (Intent):** מודל זה מאפשר לחברה להכיר ברווח באופן הדרגתי עם כל תשלום קרן המתקבל מהלקוח, ולא רק בסוף תקופת ההלוואה.

    - **טבלת סיכום שנתית (Yearly Financial Summary):**
        - **אופן הפעולה:** הטבלה משתמשת בנוסחאות `SUMIFS` כדי לסכם ערכים מהטבלה התחתונה לתוך השנה המתאימה.
        - **דוגמה:** `=SUMIFS($F$19:$F$1002, $B$19:$B$1002, "*" & H$2)` סוכם מיסים עבור שנה ספציפית.
        - **היגיון עסקי (Intent):** לספק מבט-על מהיר על הביצועים הפיננסיים של הנכס בכל שנה, ללא צורך לגלול ולסכם ידנית. השימוש בחיפוש טקסט על התאריך (`"*" & H$2`) נבחר מטעמי פשטות במימוש הראשוני.

---

## ציר 2: תהליכי צבירה ודיווח (Aggregation & Reporting)
*This section focuses on the `Summary` sheet and any other sheets that aggregate data from multiple "House" sheets.*

### 2.1 מנגנון הזיהוי (Instance Recognition)
- ** מטרה עסקית:** לקבוע אילו גיליונות במערכת הם "בתי נכס" פעילים שצריכים להיכלל בחישובי הסיכום.
- ** אופן הפעולה:** המנגנון מבוסס על רשימה ידנית בעמודה `A` של גיליון `Summary`. כאשר בית חדש נוצר או נרכש, יש להוסיף את שם הגיליון שלו באופן ידני לעמודה זו כדי שייכלל בסיכומים. זהו תהליך תפעולי ידני מכוון.
- ** הערת תחזוקה קריטית:** רוב השגיאות בחישובי הסיכום נובעות מאי-התאמה ברשימה זו. יש לוודא תמיד ששם הגיליון בעמודה A **תואם במדויק ב-100%** לשם הגיליון (tab) האמיתי, כולל רווחים, אותיות גדולות/קטנות ותווים מיוחדים.

### 2.2 הצבירה השנתית (Yearly Aggregation)
- ** מטרה עסקית:** לספק סיכום מהיר של נתונים פיננסיים שנתיים מכלל הנכסים.
- ** אופן הפעולה:** כאשר המשתמש בוחר בסוג תקופה "Yearly", הנוסחאות בגיליון `Summary` משתמשות ב-`INDEX/MATCH` כדי לשלוף את הנתון השנתי המסוכם ישירות מטבלת הסיכום העליונה של כל גיליון "בית". זוהי שיטה יעילה המסתמכת על כך שהבתים כבר ביצעו את חישובי הסיכום השנתי בעצמם.

### 2.3 הצבירה החודשית/רבעונית (Monthly/Quarterly Aggregation)
- ** מטרה עסקית:** לאפשר ניתוח גרנולרי יותר של ביצועי כלל הנכסים ברמה חודשית או רבעונית.
- ** אופן הפעולה:** כאשר נבחרת תקופה חודשית או רבעונית, הנוסחאות משתמשות בלוגיקה מורכבת יותר, המשלבת `SUMIFS` ו-`INDIRECT`. פונקציית `INDIRECT` בונה באופן דינמי את הכתובת המלאה של הטווח שיש לסרוק (למשל, `'[שם הבית]'!F:F'`), ו-`SUMIFS` סוכם את הנתונים רק עבור התקופה המבוקשת. שיטה זו מאפשרת גמישות רבה אך דורשת תחזוקה זהירה של הנוסחאות.